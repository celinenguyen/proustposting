<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    {% include "css/base.css" %}
    {% include "css/header.css" %}
    {% include "css/post-group.css" %}
    {% include "css/mentions.css" %}
    {% include "css/footer.css" %}
  </style>
</head>
<body>
  {{ content | safe }}
  <script>
    (function() {
      // Sticky header scroll effect
      const header = document.querySelector('header');
      if (header) {
        let lastScrollY = 0;
        let ticking = false;

        function updateHeader() {
          if (window.scrollY > 10) {
            header.classList.add('scrolled');
          } else {
            header.classList.remove('scrolled');
          }
          ticking = false;
        }

        window.addEventListener('scroll', function() {
          lastScrollY = window.scrollY;
          if (!ticking) {
            window.requestAnimationFrame(updateHeader);
            ticking = true;
          }
        }, { passive: true });
      }

      // Toggle post-group expansion on summary click
      document.querySelectorAll('.post-group-summary').forEach(function(summary) {
        summary.addEventListener('click', function(e) {
          if (e.target.closest('a')) return;
          summary.closest('.post-group').classList.toggle('expanded');
        });
      });

      const searchInput = document.getElementById('search');
      const container = document.getElementById('mentions-list');
      const noResults = document.getElementById('no-results');
      const visibleCount = document.getElementById('visible-count');
      const postCount = document.getElementById('post-count');

      if (!container) return;

      const mentions = container.querySelectorAll('.mention');
      const postGroups = container.querySelectorAll('.post-group');
      const totalMentions = mentions.length;

      let searchQuery = '';
      let debounceTimer;

      function updateVisibility() {
        const query = searchQuery.toLowerCase().trim();
        let visibleMentions = 0;
        let visiblePosts = 0;

        postGroups.forEach(group => {
          let groupHasVisible = false;
          const groupMentions = group.querySelectorAll('.mention');

          groupMentions.forEach(mention => {
            const context = mention.getAttribute('data-context') || '';
            const matches = !query || context.includes(query);

            if (matches) {
              mention.classList.remove('hidden');
              visibleMentions++;
              groupHasVisible = true;
            } else {
              mention.classList.add('hidden');
            }
          });

          if (groupHasVisible) {
            group.classList.remove('hidden');
            if (query) {
              group.classList.add('expanded');
            }
            visiblePosts++;
          } else {
            group.classList.add('hidden');
          }
        });

        // Collapse all when search is cleared
        if (!query) {
          postGroups.forEach(group => {
            group.classList.remove('expanded');
          });
        }

        // Update stats
        if (query) {
          visibleCount.textContent = visibleMentions + ' of ' + totalMentions;
        } else {
          visibleCount.textContent = totalMentions;
        }
        postCount.textContent = visiblePosts;

        // Show/hide no results message
        if (visibleMentions === 0 && query) {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      }

      // Search handler with debounce
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(function() {
            searchQuery = searchInput.value;
            updateVisibility();
          }, 150);
        });
      }
    })();
  </script>
</body>
</html>
