<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Lora:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    {% include "css/base.css" %}
    {% include "css/header.css" %}
    {% include "css/toolbar.css" %}
    {% include "css/stats.css" %}
    {% include "css/mentions.css" %}
  </style>
</head>
<body>
  {{ content | safe }}
  <script>
    (function() {
      const searchInput = document.getElementById('search');
      const viewListBtn = document.getElementById('view-list');
      const viewGroupedBtn = document.getElementById('view-grouped');
      const container = document.getElementById('mentions-container');
      const noResults = document.getElementById('no-results');
      const visibleCount = document.getElementById('visible-count');
      const postCount = document.getElementById('post-count');

      if (!container) return;

      const mentions = container.querySelectorAll('.mention');
      const postGroups = container.querySelectorAll('.post-group');
      const totalMentions = mentions.length;

      let currentView = 'grouped';
      let searchQuery = '';
      let debounceTimer;

      // Initialize grouped view
      container.classList.add('grouped-view');

      function updateVisibility() {
        const query = searchQuery.toLowerCase().trim();
        let visibleMentions = 0;
        let visiblePosts = 0;

        postGroups.forEach(group => {
          let groupHasVisible = false;
          const groupMentions = group.querySelectorAll('.mention');

          groupMentions.forEach(mention => {
            const context = mention.getAttribute('data-context') || '';
            const matches = !query || context.includes(query);

            if (matches) {
              mention.classList.remove('hidden');
              visibleMentions++;
              groupHasVisible = true;
            } else {
              mention.classList.add('hidden');
            }
          });

          if (currentView === 'grouped') {
            if (groupHasVisible) {
              group.classList.remove('hidden');
              visiblePosts++;
            } else {
              group.classList.add('hidden');
            }
          } else {
            group.classList.remove('hidden');
            if (groupHasVisible) visiblePosts++;
          }
        });

        // Update stats
        if (query) {
          visibleCount.textContent = visibleMentions + ' of ' + totalMentions;
        } else {
          visibleCount.textContent = totalMentions;
        }
        postCount.textContent = visiblePosts;

        // Show/hide no results message
        if (visibleMentions === 0 && query) {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      }

      function setView(view) {
        currentView = view;

        if (view === 'list') {
          container.classList.remove('grouped-view');
          container.classList.add('list-view');
          viewListBtn.classList.add('active');
          viewGroupedBtn.classList.remove('active');
        } else {
          container.classList.remove('list-view');
          container.classList.add('grouped-view');
          viewGroupedBtn.classList.add('active');
          viewListBtn.classList.remove('active');
        }

        updateVisibility();
      }

      // Search handler with debounce
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(function() {
            searchQuery = searchInput.value;
            updateVisibility();
          }, 150);
        });
      }

      // View toggle handlers
      if (viewListBtn) {
        viewListBtn.addEventListener('click', function() {
          setView('list');
        });
      }

      if (viewGroupedBtn) {
        viewGroupedBtn.addEventListener('click', function() {
          setView('grouped');
        });
      }
    })();
  </script>
</body>
</html>
